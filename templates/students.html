{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="border-bottom pb-2">Student Directory</h2>
        <p class="text-muted">Manage all student records, status, and information.</p>
    </div>
</div>

<!-- Filters -->
<div class="card card-custom glass-card mb-4 border-0">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="dept_id" class="form-label">Department</label>
                <select class="form-select" id="dept_id" name="dept_id">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if current_filters.dept_id==dept.id|string %}selected{% endif %}>{{
                        dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="year" class="form-label">Year</label>
                <select class="form-select" id="year" name="year">
                    <option value="">All Years</option>
                    <option value="1" {% if current_filters.year=='1' %}selected{% endif %}>1st Year</option>
                    <option value="2" {% if current_filters.year=='2' %}selected{% endif %}>2nd Year</option>
                    <option value="3" {% if current_filters.year=='3' %}selected{% endif %}>3rd Year</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="Active" {% if current_filters.status=='Active' %}selected{% endif %}>Active</option>
                    <option value="Long Absent" {% if current_filters.status=='Long Absent' %}selected{% endif %}>Long
                        Absent</option>
                    <option value="Discontinued" {% if current_filters.status=='Discontinued' %}selected{% endif %}>
                        Discontinued</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i> Filter
                    List</button>
            </div>
        </form>
    </div>
</div>

<div class="card card-custom glass-card border-0 mb-5">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary">Registered Students</h5>
        <div>
            <button type="button" class="btn btn-outline-primary shadow-sm" data-bs-toggle="modal"
                data-bs-target="#addTeacherModal">
                <i class="fas fa-chalkboard-teacher me-2"></i>Add Teacher
            </button>
            <a href="{{ url_for('add_student') }}" class="btn btn-success shadow-sm ms-2">
                <i class="fas fa-user-plus me-2"></i>Add Student
            </a>
        </div>
    </div>

    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Photo</th>
                        <th>UMIS / Name</th>
                        <th>Department</th>
                        <th>Year</th>
                        <th>Status</th>
                        <th>Attendance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <img src="{{ url_for('static', filename='student_photos/' + student.umis + '.jpg') }}"
                                onerror="this.src='https://via.placeholder.com/40/cccccc/ffffff?text=User'"
                                class="rounded-circle border" width="40" height="40" alt="img">
                        </td>
                        <td>
                            <div class="fw-bold">{{ student.name }}</div>
                            <small class="text-muted">{{ student.umis }}</small>
                        </td>
                        <td><span class="badge bg-info">{{ student.department.code if student.department else '-'
                                }}</span></td>
                        <td>{{ student.current_year or '-' }}</td>
                        <td>
                            {% if student.status == 'Active' %}
                            <span class="badge bg-success">Active</span>
                            {% elif student.status == 'Long Absent' %}
                            <span class="badge bg-warning">Long Absent</span>
                            {% elif student.status == 'Discontinued' %}
                            <span class="badge bg-danger">Discontinued</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ student.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if student.attendance_pct is defined %}
                            <div class="progress" style="height: 5px; width: 60px;"
                                title="{{ student.attendance_pct }}%">
                                <div class="progress-bar {% if student.attendance_pct < 75 %}bg-danger{% else %}bg-success{% endif %}"
                                    role="progressbar"
                                    style="--progress: {{ student.attendance_pct }}%; width: var(--progress);"></div>
                            </div>
                            <small>{{ student.attendance_pct }}%</small>
                            {% else %}
                            <small class="text-muted">N/A</small>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('edit_student', umis=student.umis) }}"
                                class="btn btn-sm btn-outline-primary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form action="{{ url_for('delete_student', umis=student.umis) }}" method="POST"
                                class="d-inline"
                                onsubmit="return confirm('Are you sure? This will delete all attendance records too.');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">No students found matching criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Teacher Management Section -->
<div class="card card-custom glass-card border-0">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary">Faculty & Staff Management</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Teacher Name</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Admin Access</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for teacher in teachers %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ teacher.name }}</div>
                            <small class="text-muted">{{ teacher.email }}</small>
                        </td>
                        <td><span class="badge bg-secondary">{{ teacher.department.code }}</span></td>
                        <td>{{ teacher.designation or 'Faculty' }}</td>
                        <td>
                            <form action="{{ url_for('toggle_teacher_admin', id=teacher.id) }}" method="POST">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        onchange="this.form.submit()" {% if teacher.is_admin_delegate %}checked{% endif
                                        %}>
                                    <label class="form-check-label small text-muted">Delegate Admin</label>
                                </div>
                            </form>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" title="Remove Account">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Teacher Modal (Relocated to bottom to prevent background freeze) -->
<div class="modal fade" id="addTeacherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title fw-bold">Add New Teacher Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{{ url_for('add_teacher') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Full Name</label>
                        <input type="text" name="name" class="form-control" placeholder="Dr. S. Karthikeyan" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Email Address</label>
                        <input type="email" name="email" class="form-control" placeholder="teacher@sgac.edu.in"
                            required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Department</label>
                            <select name="dept_id" class="form-select" required>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">Designation</label>
                            <input type="text" name="designation" class="form-control"
                                placeholder="HOD / Asst Professor">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Login Username</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold small">Initial Password</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    <div class="text-end border-top pt-3">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary px-4">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}